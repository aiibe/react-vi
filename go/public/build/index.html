<!DOCTYPE html>
<html lang="en" style="background-color: #e4ccad">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>React Vizu</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <script src="//unpkg.com/force-graph"></script>
    <script src="//unpkg.com/d3-quadtree"></script>
    <script src="//unpkg.com/d3-force"></script>
  </head>
  <body style="margin: 0">
    <div id="3d-graph"></div>
    <script>
      (async () => {
        // Get files map from backend
        const resp = await fetch("/data");
        const data = await resp.json();

        // Colors
        const blueLight = "#3268f0";
        const blueDark = "#6a23c2";
        const pale = "#3b2f26";
        const orange = "#d6670d";

        const files = Object.values(data).filter((f) => !f.IsDir);
        const mapFilesById = files.reduce((acc, f) => {
          acc[f.Id] = f;
          return acc;
        }, {});

        // Get .tsx nodes
        const nodes = files.map((element) => {
          const { Name, Id, Path } = element;
          const parts = Path.split("/").filter((part) => part !== Name);
          const dirName = parts[parts.length - 1] + "/" + Name;
          const name = ["index.ts", "index.tsx"].includes(Name)
            ? dirName
            : Name;

          return {
            id: Id,
            name,
            color: name.endsWith(".tsx")
              ? blueLight
              : name.endsWith(".ts")
              ? blueDark
              : name.endsWith(".css") || name.endsWith(".svg")
              ? orange
              : pale,
          };
        });

        // Get nodes linked
        const links = files.reduce((acc, item) => {
          const deps = item.Dependencies;

          if (!!deps.length) {
            deps.forEach((id) => {
              if (mapFilesById[id]) {
                acc.push({
                  source: id,
                  target: item.Id,
                  color: "#353e73",
                });
              }
            });
          }
          return acc;
        }, []);

        console.log(data, files);
        console.log({ nodes, links });

        const Graph = ForceGraph()(document.getElementById("3d-graph"))
          .graphData({ nodes, links })
          .backgroundColor("#E9F0FF")
          .linkDirectionalParticles(2)
          .linkDirectionalParticleWidth(2)
          .linkColor(() => "#172D74")
          .nodeCanvasObject((node, ctx) => {
            const label = node.name;
            const fontSize = 6;
            ctx.font = `${fontSize}px Sans-Serif`;
            const textWidth = ctx.measureText(label).width;
            const bckgDimensions = [textWidth, fontSize].map(
              (n) => n + fontSize * 0.5
            ); // some padding

            // Background
            ctx.beginPath();
            ctx.fillStyle = node.color;
            ctx.roundRect(
              node.x - bckgDimensions[0] / 2,
              node.y - bckgDimensions[1] / 2,
              ...bckgDimensions,
              [2]
            );
            ctx.fill();

            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
            ctx.fillText(label, node.x, node.y);

            node.__bckgDimensions = bckgDimensions; // to re-use in nodePointerAreaPaint
          })
          .nodePointerAreaPaint((node, color, ctx) => {
            ctx.fillStyle = color;
            const bckgDimensions = node.__bckgDimensions;
            bckgDimensions &&
              ctx.fillRect(
                node.x - bckgDimensions[0] / 2,
                node.y - bckgDimensions[1] / 2,
                ...bckgDimensions
              );
          })
          // .d3Force("charge", d3.forceManyBody().strength(-10))
          .d3Force("link", d3.forceLink().distance(50))
          .cooldownTime(1500)
          .onEngineStop(() => {
            Graph.d3Force("charge", null)
              .d3Force("link", null)
              .d3Force("center", null);
          });
      })();
    </script>
  </body>
</html>
